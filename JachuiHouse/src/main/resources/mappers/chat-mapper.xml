<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.house.jachui.chat.model.mapper.ChatMapper">

    <resultMap type="Chat" id="chatResultMap">
        <id property="chatNo" column="CHAT_NO"/>
        <result property="writerNo" column="WRITER_NO"/>
        <result property="chatSendDate" column="CHAT_SEND_DATE"/>
        <result property="chatContent" column="CHAT_CONTENT"/>
        <result property="chatFileName" column="CHAT_FILE_NAME"/>
        <result property="chatFilePath" column="CHAT_FILE_PATH"/>
        <result property="chatFileRename" column="CHAT_FILE_RENAME"/>
        <result property="receiverId" column="RECEIVER_ID"/>
    </resultMap>

    <!-- 메시지 목록 조회 -->
    <select id="selectList" resultMap="chatResultMap">
        SELECT * FROM CHAT 
        WHERE (WRITER_ID = #{writerId} AND RECEIVER_ID = #{receiverId}) 
        OR (RECEIVER_ID = #{writerId} AND WRITER_ID = #{receiverId})
        ORDER BY CHAT_SEND_DATE
    </select>

    <!-- 메시지 전송 -->
    <insert id="sendChat">
        INSERT INTO CHAT (CHAT_NO, WRITER_ID, CHAT_SEND_DATE, CHAT_CONTENT, 
                          CHAT_FILE_NAME, CHAT_FILE_PATH, CHAT_FILE_RENAME, RECEIVER_ID)
        VALUES (SEQ_CHAT_NO.NEXTVAL, #{writerId}, SYSTIMESTAMP, #{chatContent},
                #{chatFileName}, #{chatFilePath}, #{chatFileRename}, #{receiverId})
    </insert>

    <!-- 사용자별 채팅방 조회 -->
    <select id="getChatByUserId" resultMap="chatResultMap">
        SELECT * 
        FROM CHAT
        WHERE RECEIVER_ID = #{userId}
        OR WRITER_ID = #{userId}
        ORDER BY CHAT_NO DESC
    </select>

    <!-- 새 메시지 조회 -->
    <select id="selectNewMessagesAfter" resultType="Chat">
        SELECT * FROM CHAT
        WHERE (WRITER_ID = #{writerId} AND RECEIVER_ID = #{receiverId})
        OR (RECEIVER_ID = #{writerId} AND WRITER_ID = #{receiverId})
        <if test="lastChatNo != null">
            AND CHAT_NO > #{lastChatNo}
        </if>
        ORDER BY CHAT_NO ASC
    </select>

</mapper>
